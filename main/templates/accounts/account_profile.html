{% extends "base.html" %}
{% load i18n future mezzanine_tags accounts_tags staticfiles get_balance happenings_tags %}

{% block meta_title %}{{ profile_user|username_or:"get_full_name" }}{% endblock %}
{% block title %}{{ profile_user|username_or:"get_full_name" }}{% endblock %}
{% block body_id %}account{% endblock %}
{% block extra_css %}
	<link rel="stylesheet" type="text/css" href="{% static "css/profile.css" %}">
    <link rel="stylesheet" href="{% static "css/ajax_select.css" %}" />
    <link rel="stylesheet" href="{% static "css/jquery-ui.css" %}"> 
    <link href=" {% static 'css/calendar.css' %}" rel="stylesheet">

{% endblock %}
{% block extra_js %}
	<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
	<script src="{{STATIC_URL}}ajax_select/js/ajax_select.js"></script>
	<script src="{% static 'happenings/js/calendar.js' %}"></script>
	<script src="https://checkout.stripe.com/checkout.js"></script>
	<script type="text/javascript">
		function getRepeat(sel){
			if(sel.value != "NEVER"){
				$('#end_repeat').fadeIn('slow');
			} else {
				$('#end_repeat').fadeOut('slow');
			}
		};
	</script>
	<script type="text/javascript">
	//var chargedAmount = '',
	var	amountAMD = '';
	var handler = StripeCheckout.configure({
		    key: 'pk_test_9mC5ObhmQDE0DVcSxipuCNG5',
		    image: '/th.png',
		    token: function(token, args) {
		      // Use the token to create the charge with a server-side script.
		      // You can access the token ID with `token.id`
		      		//token['amount'] = amount;
			      console.log(JSON.stringify(args));
			      
			      $.ajax({
			      	type: 'POST',
			      	data: { token: token.id, email: token.email, amountAMD: amountAMD, csrfmiddlewaretoken: '{{ csrf_token }}'},
			      	url: '{% url "process_token" %}',
			      	success: function(data){
			      		
			      		$(".col-sm-6 > h4#balance").html(data.new_balance + '&nbsp;դրամ');
			      	},
			      	error: function(data){
			      		console.log(data);
			      	}
			      });
		    }
		 
	});

	
	   	  
	
	$(function(){

		$('a[id="customButton"]').click(function(e) {
    // Open Checkout with further options
	    	//chargedAmount = parseFloat($(this).data('amount')) * 100 / 411.0;
	    	//chargedAmount = chargedAmount.toFixed(2);
	    	amountAMD = $(this).data('amount') * 100;
		    handler.open({
		      name: 'Տաքսին Միասին',
		      image: '{% static 'img/th.jpeg' %}',
		      description: 'Հաշվի լիցքավորում ('+$(this).data('amount')+'դր)',
		      amount: amountAMD,
		      currency: "amd"
		    });
		    e.preventDefault();
		});

		$('#dialog-confirm').dialog({
				width: 450,
		        height: 260,
				autoOpen: false,
				modal: true,
				resizeable: false,
				buttons:{
					"Այո": function() {
						$.ajax({
							type: 'POST',
							url: '{% url "cancel_event" %}',
							data: {'event_id': $(this).data('event_id'), 'date': $(this).data('date'), 'butt_id': $(this).data('butt_id'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
							success: function(data){
								var butto = $('#'+data.butt_id);
								butto.before("(ՉԵՂԱՐԿՎԱԾ)");
								$(".col-sm-6 > h4#balance").html(data.new_balance + '.0&nbsp;դրամ');
								butto.attr('disabled','disabled');
								//$("#cancelButton").attr('disabled','disabled');
								
							},
							error: function(data){
								console.log('error: '+JSON.stringify(data));	
							}
						});
						
						$(this).dialog("close");
					},
					"Ոչ":function(){
						$(this).dialog("close");
					}
				}
		});
		$("button[id|='cancelButton']").click(function(e){
			var $event_id = $(this).data('event'),
				$date = $(this).data('date'),
				$butt_id = $(this).attr('id');
			$('#dialog-confirm')
			.data('event_id', $event_id)
			.data('date', $date)
			.data('butt_id', $butt_id)
			.dialog("open");
			return false;
		});
		
    	if($("#id_repeat :selected").text() != "Never"){
			$('#end_repeat').show();
		} else {
			$('#end_repeat').hide();
		}
		$( "#tabs" ).tabs({ heightStyle: "content"});
	  
	});
	</script>

	{{ form.media }}
{% endblock %}
{% block breadcrumb_menu %}
{{ block.super }}
{% endblock %}

{% block main %}

	
		<div class="col-sm-6">
		    <img class="img-thumbnail" src="{% gravatar_url profile_user.email 64 %}">
		    {% if profile_user == request.user %}
		    <br><a class="btn btn-primary" href="{% url "profile_update" %}">{% trans "Update profile" %}</a>
		    {% endif %}
		</div>
		<div class="col-sm-6">
			<h4>Ձեր հաշվին կա </h4>
			{% get_user_balance request as balance %}
			<h4 id="balance">{{ balance }} դրամ
			</h4>
		</div>
		
			<div id="tabs" class="col-xs-12">
				<ul>
				<li><a href="#tabs-1">Լիցքավորել Հաշիվը</a></li>
				<li><a href="#tabs-2">Պատվիրել</a></li>
				<li><a href="#tabs-3">Իմ Պատվերները</a></li>
				</ul>
				<div id="tabs-1">
				  <div class="col-xs-6">
					<a name="customButton" id="customButton" data-amount="300"><h1><span class="glyphicon glyphicon-plus"></span>300 դրամ</h1></a>
				  </div>
				  <div class="col-xs-6">
					<a name="customButton" id="customButton" data-amount="600"><h1><span class="glyphicon glyphicon-plus"></span>600 դրամ</h1></a>
				  </div>
				  <div class="col-xs-6">
					<a name="customButton" id="customButton" data-amount="1200"><h1><span class="glyphicon glyphicon-plus"></span>1200 դրամ</h1></a>
				  </div>
				  <div class="col-xs-6">
					<a name="customButton" id="customButton" data-amount="2400"><h1><span class="glyphicon glyphicon-plus"></span>2400 դրամ</h1></a>
				  </div>
				  <div class="col-xs-6">
					<a name="customButton" id="customButton" data-amount="4800"><h1><span class="glyphicon glyphicon-plus"></span>4800 դրամ</h1></a>
				  </div>
				  <div class="col-xs-6">
					<a name="customButton" id="customButton" data-amount="6000"><h1><span class="glyphicon glyphicon-plus"></span>6000 դրամ</h1></a>
				  </div>
				</div>
				<div id="tabs-2">
					<div class="col-xs-12">
						<h5>Քարտեզի վրա ընտրեք, խնդրեմ, Ձեր ուղևորության սկզբնակետն ու վերջնակետը</h5>
					</div>
					<div class="col-xs-12">
						<form method="POST">
						{% for hidden in form.hidden_fields %}
						{{ hidden }}
						{% endfor %}
						{% fields_for form.errors %}
						{# Include the visible fields #}
						{% for field in form.visible_fields %}
							{% if forloop.last %}
						        <div class="col-sm-6 lastdiv">
						        	<div id="end_repeat">
						        		{{ field.label_tag }}
						    			{{ field }}
						    		</div>
						        </div>
						    {% else %}
						    	<div class="col-sm-6">
						    		{{ field.label_tag }}<br/>
						    		{{ field }}
						    	</div>
						    {% endif %}
						{% endfor %}
						<div class="col-xs-6">
							
						</div>
						<div class="col-xs-6" id="submitDiv">
							<input id="submit" type="submit" value="submit" />
						</div>
						</form>
					</div>
				</div>
				<div id="tabs-3">
					<div class="col-md-12" id="calendar_div">

						<div id="event-calendar" class="calendar-mini">
			        		{% show_calendar request mini=True %}
					    </div>
					    <div>
					    	{% upcoming_events %}
					    </div>
					</div>
				</div>
			</div>
		

			<div id="dialog-confirm" title="Չեղարկե՞լ">
				<p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Համոզվա՞ծ եք, որ ուզում եք չեղյալ անել այս պատվերը</p>
			</div>	


{% endblock %}
