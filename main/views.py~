from django.shortcuts import render
from django.shortcuts import render_to_response
from django import forms
from django.template import RequestContext
from ajax_select.fields import AutoCompleteField
from main.forms import StreetsForm
from django.http import HttpResponseRedirect
from twilio.rest import TwilioRestClient
from django.conf import settings
from django.http import HttpResponse
from django.contrib.auth.models import User
from main.models import MyProfile

# Create your views here.
class SearchForm(forms.Form):

    q = AutoCompleteField(
            'street',
            required=True,
            help_text="Autocomplete will suggest clichs about cats, but you can enter anything you like.",
            label="Favorite Street",
            attrs={'size': 100}
            )


def search_form(request):

    dd = {}
    if 'q' in request.GET:
        dd['entered'] = request.GET.get('q')
    initial = {'q': "\"This is an initial value,\" said O'Leary."}
    form = SearchForm(initial=initial)
    dd['form'] = form
    return render_to_response('search_form.html', dd, context_instance=RequestContext(request))

import random
def _get_pin(length=5):
    """ Return a numeric PIN with length digits """
    return random.sample(range(10**(length-1), 10**length), 1)[0]


def _verify_pin(request, mobile_number, pin):
    """ Verify a PIN is correct """
    return pin == request.session.get('pin')


def ajax_send_pin(request):
    """ Sends SMS PIN to the specified number """
    if request.POST:
	    mobile_number = request.POST.get('mobile_number', "")
	    if not mobile_number:
		return HttpResponse("No mobile number", mimetype='text/plain', status=403)

	    pin = _get_pin()

	    # store the PIN in the cache for later verification.
	    request.session['pin'] = (mobile_number, pin) # valid for 24 hrs

	    client = TwilioRestClient(settings.TWILIO_ACCOUNT_SID, settings.TWILIO_AUTH_TOKEN)
	    message = client.messages.create(
		                body="%s" % pin,
		                to=mobile_number,
		                from_=settings.TWILIO_FROM_NUMBER,
		            )
	    return HttpResponse("Message %s sent, stored pin %s" % (message.sid, pin), mimetype='text/plain', status=200)

    else:
   	    return render(request, 'temp.html')

def set_user_balance(u, new_balance):
    b = MyProfile.objects.filter(user=u)[0]
    b.balance = new_balance
    b.save()

def get_user_balance(u):
    return MyProfile.objects.filter(user=u)[0].balance

def get_user_mobile(u):
    return MyProfile.objects.filter(user=u)[0].mobile_number

import stripe
import pdb
import json
def process_token(request):
	stripe.api_key = settings.STRIPE_SECRET_KEY
	u = User.objects.filter(username=request.user)[0]
	# Get the credit card details submitted by the form
	#pdb.set_trace()	
	token = request.POST['token']
	amountAMD = request.POST['amountAMD']
	#pdb.set_trace()
	
	# Create the charge on Stripe's servers - this will charge the user's card
	try:
	  charge = stripe.Charge.create(
	      amount=amountAMD, # amount in cents, again
	      currency="amd",
	      card=token,
	      description="payinguser@example.com"
	  )
	  balance = get_user_balance(u)
	  new_balance = balance + int(amountAMD) / 100
	  set_user_balance(u, new_balance)
	  return HttpResponse(json.dumps({'new_balance': str(new_balance)}), mimetype = 'application/json')
	except stripe.CardError, e:
	  # The card has been declined
	  return HttpResponse('not Cool!')

import pdb
from datetime import datetime
from happenings.models import (Cancellation, Event)
from django.template.defaultfilters import slugify
def cancelEvent(request):
	SINGLE_FARE = 300.0
	if request.method == 'POST':
		e_id = request.POST['event_id']
		dt_tm = request.POST['date']
		butt_id = request.POST['butt_id']
		date = dt_tm.rsplit(',',1)[0] #splits into 2 parts and takes the first one
		#slugified = slugify(date)
		
		u = User.objects.filter(username=request.user)[0]
	  	balance = get_user_balance(u)
	  	new_balance = balance + SINGLE_FARE
	  	set_user_balance(u, new_balance)

		
		d = datetime.strptime(date, '%b. %d, %Y')
		ev = Event.objects.get(id=e_id)
		c = Cancellation(event=ev, reason='',date=d)
		c.save()
		return HttpResponse(json.dumps({'butt_id':butt_id, 'new_balance': new_balance}), mimetype = 'application/json')


from paypal.standard.forms import PayPalPaymentsForm

def view_that_asks_for_money(request):

    # What you want the button to do.
    paypal_dict1 = {
        "business": settings.PAYPAL_RECEIVER_EMAIL,
        "amount": "0.72",
        "item_name": "300 dram",
        "invoice": "unique-invoice-id",
	"custom": "300",
        "notify_url": "http://armeninio.pythonanywhere.com" + reverse('paypal-ipn'),
        "return_url": "http://armeninio.pythonanywhere.com/your-return-location/",
        "cancel_return": "http://armeninio.pythonanywhere.com/your-cancel-location/",
    }
    paypal_dict2 = {
        "business": settings.PAYPAL_RECEIVER_EMAIL,
        "amount": "1.44",
        "item_name": "600 dram",
        "invoice": "unique-invoice-id",
	"custom": "600",
        "notify_url": "http://armeninio.pythonanywhere.com" + reverse('paypal-ipn'),
        "return_url": "http://armeninio.pythonanywhere.com/your-return-location/",
        "cancel_return": "http://armeninio.pythonanywhere.com/your-cancel-location/",
    }
    paypal_dict3 = {
        "business": settings.PAYPAL_RECEIVER_EMAIL,
        "amount": "2.88",
        "item_name": "1200 dram",
        "invoice": "unique-invoice-id",
	"custom": "1200",
        "notify_url": "http://armeninio.pythonanywhere.com" + reverse('paypal-ipn'),
        "return_url": "http://armeninio.pythonanywhere.com/your-return-location/",
        "cancel_return": "http://armeninio.pythonanywhere.com/your-cancel-location/",
    }
    paypal_dict4 = {
        "business": settings.PAYPAL_RECEIVER_EMAIL,
        "amount": "5.76",
        "item_name": "2400 dram",
        "invoice": "unique-invoice-id",
	"custom": "2400",
        "notify_url": "http://armeninio.pythonanywhere.com" + reverse('paypal-ipn'),
        "return_url": "http://armeninio.pythonanywhere.com/your-return-location/",
        "cancel_return": "http://armeninio.pythonanywhere.com/your-cancel-location/",
    }
    paypal_dict5 = {
        "business": settings.PAYPAL_RECEIVER_EMAIL,
        "amount": "11.52",
        "item_name": "4800 dram",
        "invoice": "unique-invoice-id",
	"custom": "4800",
        "notify_url": "http://armeninio.pythonanywhere.com" + reverse('paypal-ipn'),
        "return_url": "http://armeninio.pythonanywhere.com/your-return-location/",
        "cancel_return": "http://armeninio.pythonanywhere.com/your-cancel-location/",
    }
    paypal_dict6 = {
        "business": settings.PAYPAL_RECEIVER_EMAIL,
        "amount": "14.6",
        "item_name": "6000 dram",
        "invoice": "unique-invoice-id",
	"custom": "6000",
        "notify_url": "http://armeninio.pythonanywhere.com" + reverse('paypal-ipn'),
        "return_url": "http://armeninio.pythonanywhere.com/your-return-location/",
        "cancel_return": "http://armeninio.pythonanywhere.com/your-cancel-location/",
    }
    # Create the instance.
    form1 = PayPalPaymentsForm(initial=paypal_dict1)
    form2 = PayPalPaymentsForm(initial=paypal_dict2)
    form3 = PayPalPaymentsForm(initial=paypal_dict3)    
    form4 = PayPalPaymentsForm(initial=paypal_dict4)
    form5 = PayPalPaymentsForm(initial=paypal_dict5)
    form6 = PayPalPaymentsForm(initial=paypal_dict6)
    context = {"form1": form1, "form2": form2, "form3": form3, "form4": form4, "form5": form5, "form6": form6}
    return render_to_response("payment.html", context)

